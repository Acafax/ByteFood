version: '3.8'

services:
  watchtower:
    image: containrrr/watchtower:latest
    command:
      - "--label-enable"
      - "--interval"
      - "30"
      - "--cleanup"
    environment:
      - REPO_USER=${GIHUB_USERNAME}
      - REPO_PASS=${VPS_WatchTower_Read}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
  reverse-proxy:
    image: traefik:latest
    command:
      - "--configFile=/etc/traefik/traefik.yml"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - letsencrypt:/letsencrypt
      - /var/run/docker.sock:/var/run/docker.sock
      # Montujemy plik konfiguracyjny (musi byÄ‡ w tym samym folderze co docker-compose.yml)
      - ./traefik.yml:/etc/traefik/traefik.yml:ro
    depends_on:
      - backend
      - frontend
    restart: unless-stopped

  backend:
    image: ghcr.io/acafax/praca-dyplomowa:latest
    labels:
        - "traefik.enable=true"
        - "traefik.http.routers.backend.rule=Host(`bytefood.pl`) && PathPrefix(`/api`)"
        - "traefik.http.routers.backend.tls.certresolver=myresolver"
        - "traefik.http.routers.backend.entrypoints=websecure"
        - "traefik.http.services.backend.loadbalancer.server.port=8080"
        - "com.centurylinklabs.watchtower.enable=true"

    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres-db:5432/projektdyplomowy
      - POSTGRES_USER=${DB_USERNAME}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - SECRET_KEY=${SECRET_KEY}
      - SPRING_JPA_HIBERNATE_DDL_AUTO=update
      - SPRING_SQL_INIT_MODE=always
    deploy:
      mode: replicated
      replicas: 3
      update_config:
        parallelism: 1
        delay: 200s
        order: start-first
        failure_action: rollback

    depends_on:
      postgres-db:
        condition: service_healthy
    restart: unless-stopped

  postgres-db:
    image: postgres:16

    environment:
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${DB_USERNAME}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgres/data
      #- ./scripts:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d ${DB_USERNAME}"]
      interval: 10s
      timeout: 5s
      retries: 5

  frontend:
    image: ghcr.io/acafax/praca-dyplomowa-frontend:latest
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=Host(`bytefood.pl`)"
      - "traefik.http.routers.frontend.entrypoints=websecure"
      - "traefik.http.routers.frontend.tls.certresolver=myresolver"
      - "traefik.http.services.frontend.loadbalancer.server.port=80"
      - "com.centurylinklabs.watchtower.enable=true"
    build: ./frontend
    restart: unless-stopped


volumes:
  letsencrypt:
  postgres_data:
